<div class="cofmain">

  <!-- Version fiche -->
  <input type="hidden" name="attr_verfdp" value="1.0.0">
  <input type="hidden" name="attr_version" value="1.0.0">

  <!-- Token -->
  <input type="hidden" name="attr_token_url" value="">
  <input type="hidden" name="attr_token_dsp" value="">
  
  <!-- Jets -->
  <input type="hidden" name="attr_droll" value="1d20">
  <input type="hidden" name="attr_dbonus" value="2d20kh1">
  <input type="hidden" name="attr_dmalus" value="2d20kl1">
  <input type="hidden" name="attr_jnor" value="1d20">
  <input type="hidden" name="attr_jsup" value="2d20kh1">
  <input type="hidden" name="attr_jsuph" value="{2d20kh1, 0d20+10}kh1">
  <input type="hidden" name="attr_devol" value="d4">

  <!-- Buffs PJ -->
  <input type="hidden" name="attr_agi_buff" value="0">
  <input type="hidden" name="attr_con_buff" value="0">
  <input type="hidden" name="attr_for_buff" value="0">
  <input type="hidden" name="attr_per_buff" value="0">
  <input type="hidden" name="attr_cha_buff" value="0">
  <input type="hidden" name="attr_int_buff" value="0">
  <input type="hidden" name="attr_vol_buff" value="0">
  <input type="hidden" name="attr_atkcac_buff" value="0">
  <input type="hidden" name="attr_atktir_buff" value="0">
  <input type="hidden" name="attr_atkmag_buff" value="0">
  <input type="hidden" name="attr_init_buff" value="0">
  <input type="hidden" name="attr_def_buff" value="0">
  <input type="hidden" name="attr_pv_buff" value="0">
  <input type="hidden" name="attr_armor_malus" value="0">

  <!-- Entête : Logo, Avatar, Identité -->
  <div class="heading">

    <!-- Logo COF -->
    <div>
      <img
        class="logo"
        title="Version 1.0.0 - 10/2024"
        src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cof2e_logo.jpg"
      />
    </div>

    <!-- Token -->
    <div>
      <img class="token"  name="attr_character_token">
    </div>

    <!-- Identité -->
    <div class="bordered border-rounded identity">
      <input type="hidden" class="cof-head-toggle" name="attr_sheet_type" value="pc"/> 

      <!-- Identité PJ -->
      <div class="identity-pc">

        <div class="identity-row">
          <div><strong>Nom</strong></div>
          <div>
            <input type="text" name="attr_character_name" title="@{character_name}" value="">
          </div>
          <div><strong>Sexe</strong></div>
          <div>
            <input type="text" name="attr_sex" title="@{sex}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Profil / Famille</strong></div>
          <div class="d-flex">
            <input type="text" name="attr_profil" placeholder="Profil" title="@{profil}" value="">
            <input type="text" name="attr_famille" list="families" placeholder="Famille" title="@{famille}" value="">
            <datalist id="families">
              <option>Aventuriers</option>
              <option>Combattants</option>
              <option>Mages</option>
              <option>Mystiques</option>
            </datalist>
          </div>
          <div><strong>Age</strong></div>
          <div>
            <input type="text" name="attr_age" title="@{age}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Peuple</strong></div>
          <div>
            <input type="text" name="attr_peuple" title="@{peuple}" value="">
          </div>
          <div><strong>Taille</strong></div>
          <div>
            <input type="text" name="attr_taille" title="@{taille}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Idéal héroïque</strong></div>
          <div>
            <input type="text" name="attr_ideal" title="@{ideal}" value="">
          </div>
          <div><strong>Poids</strong></div>
          <div>
            <input type="text" name="attr_poids" title="@{poids}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Travers</strong></div>
          <div>
            <input type="text" name="attr_travers" title="@{travers}" value="">
          </div>
          <div></div>
          <div></div>
        </div>

      </div>

      <!-- Identité PNJ -->
      <div class="identity-npc">

        <div class="identity-row">
          <div><strong>Nom</strong></div>
          <div>
            <input type="text" name="attr_character_name" title="@{character_name}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Profil</strong></div>
          <div>
            <input type="text" name="attr_profile" title="@{profile}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Taille</strong></div>
          <div>
            <input type="text" name="attr_size" title="@{size}" value="">
          </div>
        </div>

      </div>

      <!-- Niveau & Type de fiche -->
      <div class="level-type">
        <div class="d-flex d-flex-middle">
          <strong>Niveau</strong>
        </div>
        <div class="d-flex d-flex-middle">
          <input type="number" name="attr_niveau" title="@{niveau}" value="1">
        </div>
        <div>
          <strong>Type</strong>
          <select class="select-md" name="attr_sheet_type">
            <option value="pc" selected>PJ</option>
            <option value="npc">PNJ</option>
          </select>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Fiches -->
  <div class="cofsheet">
    <input type="hidden" class="cof-type-toggle" name="attr_sheet_type" value="pc"/> 

    <!-- Fiche PJ -->
    <div class="cof-pc">
      <input type="hidden" class="tabs-toggle" name="attr_pc_tab" value="main" />
      <div>
        <button type="action" name="act_pc_main-btn" class="main-tab tab-btn pc-main-btn">CARACS</button>
        <button type="action" name="act_pc_abilities-btn" class="main-tab tab-btn pc-abilities-btn">CAPACITES</button>
        <button type="action" name="act_pc_gears-btn" class="main-tab tab-btn pc-gears-btn">EQUIPEMENT</button>
        <button type="action" name="act_pc_config-btn" class="main-tab tab-btn pc-config-btn">CONFIGURATION</button>
        <button type="action" name="act_pc_version-btn" class="main-tab tab-btn pc-version-btn">VERSION</button>
      </div>

      <!-- Fiche PJ, Onglet Caracs -->
      <div class="pc-main-tab">

        <div class="pc-attributes">
  
          <!-- Caractéristiques -->
          <div class="traits">

            <div class="trait">
              <h4>Carac</h4>
              <h4></h4>
              <h4>Mod</h4>
              <h4>Bonus</h4>
              <h4>Test</h4>
            </div>

            <!-- AGI -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_agi-btn">
                  <span class="d20-btn">t</span>
                  AGI
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_dagi_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_agi" title="@{agi}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_agi_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_agi_test" title="@{agi_test}" value="0">
                <span name="attr_agi_test"></span>
              </div>
            </div>

            <!-- CON -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_con-btn">
                  <span class="d20-btn">t</span>
                  CON
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_con_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_con" title="@{con}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_con_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_con_test" title="@{con_test}" value="0">
                <span name="attr_con_test"></span>
              </div>
            </div>

            <!-- FOR -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_for-btn">
                  <span class="d20-btn">t</span>
                  FOR
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_for_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_for" title="@{for}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_for_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_for_test" title="@{for_test}" value="0">
                <span name="attr_for_test"></span>
              </div>
            </div>

            <!-- PER -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_per-btn">
                  <span class="d20-btn">t</span>
                  PER
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_per_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_per" title="@{per}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_per_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_per_test" title="@{per_test}" value="0">
                <span name="attr_per_test"></span>
              </div>
            </div>

            <!-- CHA -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_cha-btn">
                  <span class="d20-btn">t</span>
                  CHA
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_cha_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_cha" title="@{cha}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_cha_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_cha_test" title="@{cha_test}" value="0">
                <span name="attr_cha_test"></span>
              </div>
            </div>

            <!-- INT -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_int-btn">
                  <span class="d20-btn">t</span>
                  INT
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_int_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_int" title="@{int}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_int_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_int_test" title="@{int_test}" value="0">
                <span name="attr_int_test"></span>
              </div>
            </div>

            <!-- VOL -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_vol-btn">
                  <span class="d20-btn">t</span>
                  VOL
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_vol_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_vol" title="@{vol}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_vol_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_vol_test" title="@{vol_test}" value="0">
                <span name="attr_vol_test"></span>
              </div>
            </div>

          </div>

          <!-- Scores d'attaque -->
          <div class="attacks">

            <div class="attack">
              <h4>Combat</h4>
              <h4>Base</h4>
              <h4>Mod.</h4>
              <h4>Div.</h4>
              <h4><strong>Score</strong></h4>
            </div>

            <!-- Init -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_init-btn">
                  <span class="d20-btn">t</span>
                  INITIATIVE
                </button>
              </div>
              <div class="centered bordered">
                10
              </div>
              <div class="centered bordered">
                PER : <span name="attr_per"></span>
              </div>
              <div class="centered bordered">
                <span attr="attr_init_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_init" value="0">
                <span name="attr_init" title="@{init}"></span>
              </div>
            </div>

            <!-- CONTACT -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atkcac-btn">
                  <span class="d20-btn">t</span>
                  AU CONTACT
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atkcac_base" title="@{atkcac_base}" value="0">
              </div>
              <div class="centered bordered">
                FOR : <span name="attr_for"></span>
              </div>
              <div class="centered bordered">
                <span attr="attr_atkcac_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atkcac" value="0">
                <span name="attr_atkcac" title="@{atkcac}"></span>
              </div>
            </div>

            <!-- DISTANCE -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atktir-btn">
                  <span class="d20-btn">t</span>
                  A DISTANCE
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atktir_base" title="@{atktir_base}" value="0">
              </div>
              <div class="centered bordered">
                AGI : <span name="attr_agi"></span>
              </div>
              <div class="centered bordered">
                <span attr="attr_atktir_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atktir" value="0">
                <span name="attr_atktir" title="@{atktir}"></span>
              </div>
            </div>

            <!-- MAGIE -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atkmag-btn">
                  <span class="d20-btn">t</span>
                  MAGIE
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atkmag_base" title="@{atkmag_base}" value="0">
              </div>
              <div class="centered bordered">
                VOL : <span name="attr_vol"></span>
              </div>
              <div class="centered bordered">
                <span attr="attr_atkmag_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atkmag" value="0">
                <span name="attr_atkmag" title="@{atkmag}"></span>
              </div>
            </div>

          </div>
          
          <!-- VIGUEUR & MISC -->
          <div class="vitality">

            <!-- PV -->
            <div class="centered">
              <h4>POINTS DE VIGUEUR</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn img-btn img-btn-lg" type="action" name="act_vploss-btn">
                  <span class="img-btn img-btn-lg">e</span>
                </button>
                PV
                <button class="flat-btn img-btn img-btn-lg" type="action" name="act_vpheal-btn">
                  <span class="img-btn img-btn-lg">k</span>
                </button>
              </div>

              <div class="bordered centered">
                <input type="number" name="attr_pv" title="@{pv}" value="0">
                /
                <input type="number" name="attr_pv_max" title="@{pv_max}" value="0">
              </div>

            </div>

            <!-- DR -->
            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn" type="action" name="act_drecup-btn">
                  DR
                </button>
                <select name="attr_drecup" class="select-xs" title="@{drecup}">
                  <option value="6">d6</option>
                  <option value="8">d8</option>
                  <option value="10">d10</option>
                </select>
              </div>

              <div class="bordered centered">
                <input type="number" name="attr_dr" title="@{dr}" value="0">
                /
                <input type="number" name="attr_dr_max" title="@{dr_max}" value="0">
              </div>

            </div>

            <div class="bordered centered hit">
              DM temporaires
              <input type="number" name="attr_temp_dm" title="@{temp_dm}" value="">
            </div>

            <!-- PM -->
            <div class="centered">
              <h4>POINTS DE MANA</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">PM</div>

              <div class="bordered centered">
                <input type="number" name="attr_pm" title="@{pm}" value="0">
                /
                <input type="number" name="attr_pm_max" title="@{pm_max}" value="0">
              </div>

            </div>

            <!-- D4° -->
            <div class="centered">
              <h4>DE EVOLUTIF</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn" type="action" name="act_devol-btn">
                  D4°
                </button>
              </div>

              <div class="bordered centered">
                <span name="attr_devol"></span>
              </div>

            </div>

          </div>
  
        </div>
  
        <!-- Conditions & Défenses -->
        <div class="pc-cond-def">
  
          <div class="conditions">
            <div class="centered block-header">Etats préjudiciables</div>
            <div class="bordered centered">
              <span name="attr_conditions" value=""></span>
              
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_affaibli"
                title="Affaibli"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_affaibli.png"
                />
              </button>

              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_aveugle"
                title="Aveuglé"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_aveugle.png"
                />
              </button>
    
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_essoufle"
                title="Essouflé"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_essoufle.png"
                />
              </button>
<!-- 
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_effraye"
                title="Effrayé"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_effraye.png"
                />
              </button>
 -->    
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_etourdi"
                title="Etourdi"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_etourdi.png"
                />
              </button>

              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_immobilise"
                title="Immobilisé"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_immobilise.png"
                />
              </button>
<!-- 
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_panique"
                title="Paniqué"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_panique.png"
                />
              </button> -->

              <br>
              
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_invalide"
                title="Invalide"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_invalide.png"
                />
              </button>
    
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_paralyse"
                title="Paralysé"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_paralyse.png"
                />
              </button>
    
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_ralenti"
                title="Ralenti"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_ralenti.png"
                />
              </button>
    
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_renverse"
                title="Renversé"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_renverse.png"
                />
              </button>                
    
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_surpris"
                title="Surpris"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_surpris.png"
                />
              </button>

            </div>
          </div>

          <div class="defenses">

            <div class="defense">
              <div><strong>DEFENSE</strong></div>
              <div></div>
              <div class="centered">
                Armure
                <input type="checkbox" name="attr_armure_on" title="@{armure_on}" value="0">
              </div>
              <div class="centered">
                Bouclier
                <input type="checkbox" name="attr_bouclier_on" title="@{bouclier_on}" value="0">
              </div>
              <div class="centered">AGI</div>
              <div class="centered">Div.</div>
              <div class="centered">Action défensive</div>
              <div class="centered"><strong>Score</strong></div>
            </div>

            <div class="defense">
              <div class="block-title">DEF</div>
              <div class="bordered centered">10+</div>
              <div class="bordered centered">
                <input type="number" name="attr_armure" title="@{armure}" value="0">
              </div>
              <div class="bordered centered">
                <input type="number" name="attr_bouclier" title="@{bouclier}" value="0">
              </div>
              <div class="bordered centered">
                <span name="attr_agi"></span>
              </div>
              <div class="bordered centered">
                <span name="attr_def_buff"></span>
              </div>
              <div class="bordered centered">
                <select class="select-md" name="attr_defact" title="@{defact}">
                  <option value="">-</option>
                  <option value="2">Simple</option>
                  <option value="5">Totale (L)</option>
                </select>
              </div>
              <div class="bordered centered">
                <span name="attr_def"></span>
              </div>
            </div>

            <div class="defense">
              <div class="centered"><strong>Malus</strong></div>
              <div></div>
              <div class="bordered centered">
                <input type="number" name="attr_armure_malus" title="@{armure_malus}" value="0">
              </div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
            </div>

          </div>
  
        </div>

        <!-- PC & RD -->
        <div class="pc-luck-rd">

          <div class="luck">
            <div class="block-title">
              <button class="block-title" type="action" name="act_luck-btn">
                <span class="d20-btn">t</span>
                PC
              </button>
            </div>
            <div class="bordered">
              <div class="d-flex d-flex-middle">
                <input type="hidden" name="attr_pc_max" value="0">
                <input type="number" name="attr_pc" title="@{pc}" value="0">
                &nbsp;/&nbsp;
                <span name="attr_pc_max"></span>
                &nbsp;=&nbsp;
                <input type="number" name="attr_pc_base" title="@{pc_base}" value="0">
                &nbsp;+&nbsp;
                <span name="attr_cha"></span>
                &nbsp;+&nbsp;
                <input type="number" name="attr_pc_buff" title="@{pc_buff}" value="0">
              </div>
            </div>
          </div>

          <div class="dmred">
            <div class="block-title">RD</div>
            <div class="bordered">
              <input type="text" name="attr_rd" title="@{rd}" value="">
            </div>
          </div>

        </div>

        <hr>

        <!-- Attaques & Armes -->
        <div class="pc-attacks">
          
          <div class="weapon">
            <div></div>
            <h4>ARMES</h4>
            <h4>ATTAQUE</h4>
            <h4>CRIT.</h4>
            <h4>DM</h4>
            <h4>PORTEE</h4>
            <h4>SPECIAL</h4>
          </div>

          <fieldset class="repeating_armes">

            <div class="weapon">
              
              <div>
                <button type="roll" class="flat-btn"></button>
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-nom" title="@{arme-nom}" placeholder="Arme/attaque" value="">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <select class="select-md" name="attr_arme-atk" title="@{arme-atk}">
                  <option value="atkcac" selected>CONTACT</option>
                  <option value="atktir">DISTANCE</option>
                  <option value="atkmag">MAGIE</option>
                </select>
                <span>+</span>
                <input type="number" name="attr_arme-atkdiv" title="@{arme-atkdiv}" value="">
                <input type="hidden" name="attr_arme-buffatk" value="0">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="number" name="attr_arme-crit" title="@{arme-crit} Seuil de Critique" value="20" min="2" max="20">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-dm" title="@{arme-dm}" placeholder="1d8, 2d6..." value="">
                <span>+</span>
                <select class="select-md" name="attr_arme-bonus" title="@{arme-bonus} Bonus aux dommages">
                  <option value="0">-</option>
                  <option value="agi">AGI</option>
                  <option value="for" selected>FOR</option>
                  <option value="per">PER</option>
                  <option value="int">INT</option>
                  <option value="cha">CHA</option>
                </select>
                <span>+</span>
                <input type="number" name="attr_arme-dmdiv" title="@{arme-dmdiv} Bonus DM divers" value="0">
                <input type="hidden" name="attr_arme-buffdm" value="0">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-portee" title="@{arme-portee}" value="">
                <input type="hidden" name="attr_arme-portees" value="">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-special" title="@{arme-special}" placeholder="Effet, capacités spéciales ... " value="">
              </div>
              <!-- <button type="action" class="flat-btn img-btn" name="act_arme-opt-btn">
                <span class="img-btn">y</span>
              </button> -->

            </div>

            <input type="hidden" class="cof-wopt-toggle" name="attr_arme-opt" value="0"/>
            <div class="weapon-opt">
              <div class="weapon-option">
                <div></div>
                <div class="bordered">
                </div>
                <div class="bordered">
                </div>
                <div class="bordered">
                </div>
                <div class="bordered">
                </div>
                <div></div>
              </div>
            </div>

          </fieldset>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Capacités -->
      <div class="pc-abilities-tab">

        <input type="checkbox" class="block-switch" name="attr_abilities_edit" value="1">
        
        <!-- Fiche PJ, Onglet Capacités, Mode Affichage -->
        <div class="abilities-view">
          <div class="d-flex d-flex-between">
            <div>
              <h3>CAPACITES</h3>
            </div>
            <div class="change-view">
              Editer <input type="checkbox" name="attr_abilities_edit" value="1">
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 1-3 -->
          <div class="abilities">
            <!-- Voie 1 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie1nom"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r1" title="@{v1r1}" value="1">
                      <span class="rank-title" name="attr_voie1-t1"></span>
                      <button type="action" class="flat-btn" name="act_v1r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-1" title="@{voie1-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r2" title="@{v1r2}" value="1">
                      <span class="rank-title" name="attr_voie1-t2"></span>
                      <button type="action" class="flat-btn" name="act_v1r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-2" title="@{voie1-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->  
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r3" title="@{v1r3}" value="1">
                      <span class="rank-title" name="attr_voie1-t3"></span>
                      <button type="action" class="flat-btn" name="act_v1r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-3" title="@{voie1-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r4" title="@{v1r4}" value="1">
                      <span class="rank-title" name="attr_voie1-t4"></span>
                      <button type="action" class="flat-btn" name="act_v1r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-4" title="@{voie1-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r5" title="@{v1r5}" value="1">
                      <span class="rank-title" name="attr_voie1-t5"></span>
                      <button type="action" class="flat-btn" name="act_v1r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-5" title="@{voie1-5}"></span>
                </details>
              </div>
            </div>
            <!-- Voie 2 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie2nom"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r1" title="@{v2r1}" value="1">
                      <span class="rank-title" name="attr_voie2-t1"></span>
                      <button type="action" class="flat-btn" name="act_v2r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-1" title="@{voie2-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r2" title="@{v2r2}" value="1">
                      <span class="rank-title" name="attr_voie2-t2"></span>
                      <button type="action" class="flat-btn" name="act_v2r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-2" title="@{voie2-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r3" title="@{v2r3}" value="1">
                      <span class="rank-title" name="attr_voie2-t3"></span>
                      <button type="action" class="flat-btn" name="act_v2r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-3" title="@{voie2-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r4" title="@{v2r4}" value="1">
                      <span class="rank-title" name="attr_voie2-t4"></span>
                      <button type="action" class="flat-btn" name="act_v2r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-4" title="@{voie2-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r5" title="@{v2r5}" value="1">
                      <span class="rank-title" name="attr_voie2-t5"></span>
                      <button type="action" class="flat-btn" name="act_v2r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-5" title="@{voie2-5}"></span>
                </details>
              </div>
            </div>
            <!-- Voie 3 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie3nom"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r1" title="@{v3r1}" value="1">
                      <span class="rank-title" name="attr_voie3-t1"></span>
                      <button type="action" class="flat-btn" name="act_v3r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-1" title="@{voie3-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r2" title="@{v3r2}" value="1">
                      <span class="rank-title" name="attr_voie3-t2"></span>
                      <button type="action" class="flat-btn" name="act_v3r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-2" title="@{voie3-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r3" title="@{v3r3}" value="1">
                      <span class="rank-title" name="attr_voie3-t3"></span>
                      <button type="action" class="flat-btn" name="act_v3r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-3" title="@{voie3-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r4" title="@{v3r4}" value="1">
                      <span class="rank-title" name="attr_voie3-t4"></span>
                      <button type="action" class="flat-btn" name="act_v3r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-4" title="@{voie3-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r5" title="@{v3r5}" value="1">
                      <span class="rank-title" name="attr_voie3-t5"></span>
                      <button type="action" class="flat-btn" name="act_v3r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-5" title="@{voie3-5}"></span>
                </details>
              </div>
            </div>
          </div>
  
          <!-- Fiche PJ, Onglet Capacités, Voies 4-6 -->
          <div class="abilities">
            <!-- Voie 4 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie4nom" title="@{voie4nom}"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r1" title="@{v4r1}" value="1">
                      <span class="rank-title" name="attr_voie4-t1"></span>
                      <button type="action" class="flat-btn" name="act_v4r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-1" title="@{voie4-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r2" title="@{v4r2}" value="1">
                      <span class="rank-title" name="attr_voie4-t2"></span>
                      <button type="action" class="flat-btn" name="act_v4r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-2" title="@{voie4-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r3" title="@{v4r3}" value="1">
                      <span class="rank-title" name="attr_voie4-t3"></span>
                      <button type="action" class="flat-btn" name="act_v4r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-3" title="@{voie4-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r4" title="@{v4r4}" value="1">
                      <span class="rank-title" name="attr_voie4-t4"></span>
                      <button type="action" class="flat-btn" name="act_v4r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-4" title="@{voie4-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r5" title="@{v4r5}" value="1">
                      <span class="rank-title" name="attr_voie4-t5"></span>
                      <button type="action" class="flat-btn" name="act_v4r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-5" title="@{voie4-5}"></span>
                </details>
              </div>
            </div>
            <!-- Voie 5 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie5nom" title="@{voie5nom}"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r1" title="@{v5r1}" value="1">
                      <span class="rank-title" name="attr_voie5-t1"></span>
                      <button type="action" class="flat-btn" name="act_v5r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-1" title="@{voie5-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r2" title="@{v5r2}" value="1">
                      <span class="rank-title" name="attr_voie5-t2"></span>
                      <button type="action" class="flat-btn" name="act_v5r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-2" title="@{voie5-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r3" title="@{v5r3}" value="1">
                      <span class="rank-title" name="attr_voie5-t3"></span>
                      <button type="action" class="flat-btn" name="act_v5r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-3" title="@{voie5-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r4" title="@{v5r4}" value="1">
                      <span class="rank-title" name="attr_voie5-t4"></span>
                      <button type="action" class="flat-btn" name="act_v5r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-4" title="@{voie5-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r5" title="@{v5r5}" value="1">
                      <span class="rank-title" name="attr_voie5-t5"></span>
                      <button type="action" class="flat-btn" name="act_v5r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-5" title="@{voie5-5}"></span>
                </details>
              </div>
            </div>
            <!-- Voie 6 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie6nom" title="@{voie6nom}"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r1" title="@{v6r1}" value="1">
                      <span class="rank-title" name="attr_voie6-t1"></span>
                      <button type="action" class="flat-btn" name="act_v6r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-1" title="@{voie6-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r2" title="@{v6r2}" value="1">
                      <span class="rank-title" name="attr_voie6-t2"></span>
                      <button type="action" class="flat-btn" name="act_v6r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-2" title="@{voie6-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r3" title="@{v6r3}" value="1">
                      <span class="rank-title" name="attr_voie6-t3"></span>
                      <button type="action" class="flat-btn" name="act_v6r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-3" title="@{voie6-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r4" title="@{v6r4}" value="1">
                      <span class="rank-title" name="attr_voie6-t4"></span>
                      <button type="action" class="flat-btn" name="act_v6r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-4" title="@{voie6-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r5" title="@{v6r5}" value="1">
                      <span class="rank-title" name="attr_voie6-t5"></span>
                      <button type="action" class="flat-btn" name="act_v6r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-5" title="@{voie6-5}"></span>
                </details>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 7-9 -->
          <div class="abilities">
            <!-- Voie 7 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie7nom" title="@{voie7nom}"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r1" title="@{v7r1}" value="1">
                      <span class="rank-title" name="attr_voie7-t1"></span>
                      <button type="action" class="flat-btn" name="act_v7r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-1" title="@{voie7-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r2" title="@{v7r2}" value="1">
                      <span class="rank-title" name="attr_voie7-t2"></span>
                      <button type="action" class="flat-btn" name="act_v7r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-2" title="@{voie7-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r3" title="@{v7r3}" value="1">
                      <span class="rank-title" name="attr_voie7-t3"></span>
                      <button type="action" class="flat-btn" name="act_v7r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-3" title="@{voie7-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r4" title="@{v7r4}" value="1">
                      <span class="rank-title" name="attr_voie7-t4"></span>
                      <button type="action" class="flat-btn" name="act_v7r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-4" title="@{voie7-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r5" title="@{v7r5}" value="1">
                      <span class="rank-title" name="attr_voie7-t5"></span>
                      <button type="action" class="flat-btn" name="act_v7r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-5" title="@{voie7-5}"></span>
                </details>
              </div>
            </div>
            <!-- Voie 8 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie8nom" title="@{voie8nom}"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r1" title="@{v8r1}" value="1">
                      <span class="rank-title" name="attr_voie8-t1"></span>
                      <button type="action" class="flat-btn" name="act_v8r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-1" title="@{voie8-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r2" title="@{v8r2}" value="1">
                      <span class="rank-title" name="attr_voie8-t2"></span>
                      <button type="action" class="flat-btn" name="act_v8r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-2" title="@{voie8-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r3" title="@{v8r3}" value="1">
                      <span class="rank-title" name="attr_voie8-t3"></span>
                      <button type="action" class="flat-btn" name="act_v8r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-3" title="@{voie8-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r4" title="@{v8r4}" value="1">
                      <span class="rank-title" name="attr_voie8-t4"></span>
                      <button type="action" class="flat-btn" name="act_v8r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-4" title="@{voie8-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r5" title="@{v8r5}" value="1">
                      <span class="rank-title" name="attr_voie8-t5"></span>
                      <button type="action" class="flat-btn" name="act_v8r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-5" title="@{voie8-5}"></span>
                </details>
              </div>
            </div>
            <!-- Voie 9 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie9nom" title="@{voie9nom}"></span>
              </div>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r1" title="@{v9r1}" value="1">
                      <span class="rank-title" name="attr_voie9-t1"></span>
                      <button type="action" class="flat-btn" name="act_v9r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-1" title="@{voie9-1}"></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r2" title="@{v9r2}" value="1">
                      <span class="rank-title" name="attr_voie9-t2"></span>
                      <button type="action" class="flat-btn" name="act_v9r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-2" title="@{voie9-2}"></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r3" title="@{v9r3}" value="1">
                      <span class="rank-title" name="attr_voie9-t3"></span>
                      <button type="action" class="flat-btn" name="act_v9r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-3" title="@{voie9-3}"></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r4" title="@{v9r4}" value="1">
                      <span class="rank-title" name="attr_voie9-t4"></span>
                      <button type="action" class="flat-btn" name="act_v9r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-4" title="@{voie9-4}"></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r5" title="@{v9r5}" value="1">
                      <span class="rank-title" name="attr_voie9-t5"></span>
                      <button type="action" class="flat-btn" name="act_v9r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-5" title="@{voie9-5}"></span>
                </details>
              </div>
            </div>
          </div>

        </div>

        <!-- Fiche PJ, Onglet Capacités, Mode Edition -->
        <div class="abilities-edit">
          <div class="d-flex d-flex-between">
            <div>
              <h3>CAPACITES</h3>
            </div>
            <div class="change-view">
              Afficher <input type="checkbox" name="attr_abilities_edit" value="1">
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 1-3 -->
          <div class="abilities">
            <div class="path bordered">
              <div class="block-title">Voie n°1</div>
              <div class="path-title">
                <input type="text" name="attr_voie1nom" title="@{voie1nom}" value="Voie n°1">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie1-t1" title="@{voie1-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie1-1" title="@{voie1-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie1-t2" title="@{voie1-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie1-2" title="@{voie1-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie1-t3" title="@{voie1-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie1-3" title="@{voie1-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie1-t4" title="@{voie1-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie1-4" title="@{voie1-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie1-t5" title="@{voie1-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie1-5" title="@{voie1-5}" placeholder="Description"></textarea>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">Voie n°2</div>
              <div class="path-title">
                <input type="text" name="attr_voie2nom" title="@{voie2nom}" value="Voie n°2">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie2-t1" title="@{voie2-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie2-1" title="@{voie2-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie2-t2" title="@{voie2-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie2-2" title="@{voie2-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie2-t3" title="@{voie2-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie2-3" title="@{voie2-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie2-t4" title="@{voie2-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie2-4" title="@{voie2-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie2-t5" title="@{voie2-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie2-5" title="@{voie2-5}" placeholder="Description"></textarea>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">Voie n°3</div>
              <div class="path-title">
                <input type="text" name="attr_voie3nom" title="@{voie3nom}" value="Voie n°3">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie3-t1" title="@{voie3-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie3-1" title="@{voie3-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie3-t2" title="@{voie3-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie3-2" title="@{voie3-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie3-t3" title="@{voie3-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie3-3" title="@{voie3-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie3-t4" title="@{voie3-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie3-4" title="@{voie3-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie3-t5" title="@{voie3-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie3-5" title="@{voie3-5}" placeholder="Description"></textarea>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 4-6 -->
          <div class="abilities">
            <div class="path bordered">
              <div class="block-title">Voie n°4</div>
              <div class="path-title">
                <input type="text" name="attr_voie4nom" title="@{voie4nom}" value="Voie n°4">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie4-t1" title="@{voie4-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie4-1" title="@{voie4-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie4-t2" title="@{voie4-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie4-2" title="@{voie4-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie4-t3" title="@{voie4-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie4-3" title="@{voie4-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie4-t4" title="@{voie4-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie4-4" title="@{voie4-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie4-t5" title="@{voie4-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie4-5" title="@{voie4-5}" placeholder="Description"></textarea>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">Voie n°5</div>
              <div class="path-title">
                <input type="text" name="attr_voie5nom" title="@{voie5nom}" value="Voie n°5">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie5-t1" title="@{voie5-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie5-1" title="@{voie5-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie5-t2" title="@{voie5-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie5-2" title="@{voie5-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie5-t3" title="@{voie5-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie5-3" title="@{voie5-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie5-t4" title="@{voie5-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie5-4" title="@{voie5-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie5-t5" title="@{voie5-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie5-5" title="@{voie5-5}" placeholder="Description"></textarea>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">Voie n°6</div>
              <div class="path-title">
                <input type="text" name="attr_voie6nom" title="@{voie6nom}" value="Voie n°6">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie6-t1" title="@{voie6-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie6-1" title="@{voie6-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie6-t2" title="@{voie6-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie6-2" title="@{voie6-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie6-t3" title="@{voie6-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie6-3" title="@{voie6-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie6-t4" title="@{voie6-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie6-4" title="@{voie6-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie6-t5" title="@{voie6-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie6-5" title="@{voie6-5}" placeholder="Description"></textarea>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 7-9 -->
          <div class="abilities">
            <div class="path">
              <div class="block-title">Voie n°7</div>
              <div class="path-title">
                <input type="text" name="attr_voie7nom" title="@{voie7nom}" value="Voie n°7">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie7-t1" title="@{voie7-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie7-1" title="@{voie7-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie7-t2" title="@{voie7-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie7-2" title="@{voie7-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie7-t3" title="@{voie7-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie7-3" title="@{voie7-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie7-t4" title="@{voie7-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie7-4" title="@{voie7-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie7-t5" title="@{voie7-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie7-5" title="@{voie7-5}" placeholder="Description"></textarea>
              </div>
            </div>
            <div class="path">
              <div class="block-title">Voie n°8</div>
              <div class="path-title">
                <input type="text" name="attr_voie8nom" title="@{voie8nom}" value="Voie n°8">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie8-t1" title="@{voie8-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie8-1" title="@{voie8-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie8-t2" title="@{voie8-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie8-2" title="@{voie8-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie8-t3" title="@{voie8-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie8-3" title="@{voie8-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie8-t4" title="@{voie8-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie8-4" title="@{voie8-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie8-t5" title="@{voie8-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie8-5" title="@{voie8-5}" placeholder="Description"></textarea>
              </div>
            </div>
            <div class="path">
              <div class="block-title">Voie n°9</div>
              <div class="path-title">
                <input type="text" name="attr_voie9nom" title="@{voie9nom}" value="Voie n°9">
              </div>
              <div class="rank">
                <input type="text" name="attr_voie9-t1" title="@{voie9-t1}" placeholder="Nom de la capacité">
                <textarea name="attr_voie9-1" title="@{voie9-1}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie9-t2" title="@{voie9-t2}" placeholder="Nom de la capacité">
                <textarea name="attr_voie9-2" title="@{voie9-2}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie9-t3" title="@{voie9-t3}" placeholder="Nom de la capacité">
                <textarea name="attr_voie9-3" title="@{voie9-3}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie9-t4" title="@{voie9-t4}" placeholder="Nom de la capacité">
                <textarea name="attr_voie9-4" title="@{voie9-4}" placeholder="Description"></textarea>
              </div>
              <div class="rank">
                <input type="text" name="attr_voie9-t5" title="@{voie9-t5}" placeholder="Nom de la capacité">
                <textarea name="attr_voie9-5" title="@{voie9-5}" placeholder="Description"></textarea>
              </div>
            </div>
          </div>

        </div>

        <!-- Fiche PJ, Onglet Capacités, Sous-onglets -->
        <input type="hidden" class="tabs-toggle" name="attr_pc_subtab" value="rolls" />
        <div class="pc-subtabs">
          <button type="action" name="act_pc_rolls-btn" class="sub-tab tab-btn pc-rolls-btn">JETS</button>
          <button type="action" name="act_pc_buffs-btn" class="sub-tab tab-btn pc-buffs-btn">BUFFS</button>
        </div>
        
        <hr>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Jets -->
        <div class="pc-rolls-subtab">
          
          <h4>Jets de capacités</h4>

          <fieldset class="repeating_rolls">

            <div class="pc-roll-r1">

              <div>
                <button class="flat-btn" type="action" name="act_ability-roll-btn">
                  <span class="d20-btn">t</span>
                </button>
              </div>

              <div class="bordered">Nom</div>

              <div class="bordered">Jet</div>

              <div class="bordered">Vx Rx</div>

            </div>

            <div class="pc-roll-r2">

              <div>

              </div>

              <div class="bordered">
                Compétence (CAR)
              </div>

              <div class="bordered">
                Description
              </div>

            </div>

          </fieldset>

        </div>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Buffs -->
        <div class="pc-buffs-subtab">
          <h4>Buffs</h4>

          <fieldset class="repeating_buffs">

            <div class="pc-buffs">

              <div class="bordered d-flex">
  
                <input type="checkbox" name="attr_buffon" title="@{buffon}" value="1">
                <input type="text" name="attr_buffnom" title="@{buffnom}" placeholder="Nom du buff/debuff" value="">
  
              </div>
  
              <div class="bordered d-flex">
  
                <input type="text" name="attr_buffmods" title="@{buffmods}" placeholder="Attribut:Valeur; Attribut:Valeur; ..." value="">
  
              </div>

            </div>


          </fieldset>

          <hr>

          Détail par attribut
        </div>
      </div>

      <!-- Fiche PJ, Onglet Equipement -->
      <div class="pc-gears-tab">
        
        <div class="pc-gears">

          <!-- Liste des équipements -->
          <div class="gears">

            <div class="block-title block-header">
              Equipements
            </div>

            <div class="bordered">
              <div class="d-flex d-flex-middle">
                &nbsp;Trésor&nbsp;:&nbsp;<input type="text" name="attr_tresor" title="@{tresor}" value="">
                &nbsp;Enc. Total&nbsp;:&nbsp;<span name="attr_total_enc" title="@{total_enc} Encombrement total"></span>
                &nbsp;/&nbsp;<input type="number" name="attr_seuil_enc" title="@{seuil_enc}" value="0">
              </div>
            </div>

            <div class="bordered">
              
              <fieldset class="repeating_equipement">

                <details>
                  <summary>

                    <span>
                      <input type="checkbox" name="attr_equip-util" title="@{equip-util}" value="1">
                      <input type="text" class="equip-desc" name="attr_equip-desc" title="@{equip-desc}">
                      Enc. <input type="number" name="attr_equip-enc" title="@{equip-enc}" value="0">
                      Nbre <input type="number" name="attr_equip-qte" title="@{equip-qte}" value="1">
                      <input type="checkbox" name="attr_equip-on" title="@{equip-on}" value="1">
                    </span>

                  </summary>

                  <div class="d-flex">
                    <input type="text" name="attr_equip-detail" title="@{equip-detail}" value="">
                  </div>

                  <div class="d-flex d-flex-middle">
                    <input type="text" name="attr_equip-props" title="@{equip-props}" value="">
                    <input type="checkbox" name="attr_equip-atk" title="@{equip-atk}" value="1">
                    &nbsp;A une attaque
                  </div>

                </details>


              </fieldset>

            </div>
          </div>

          <!-- Liste des ressources -->
          <div class="resources">
            <div class="block-title block-header">
              Ressources
            </div>

            <div class="bordered">
              
              <fieldset class="repeating_ressources">

                <div class="d-flex">
                  <input type="text" name="attr_res-desc" title="@{res-desc}" value="">
                  Valeur :
                  <input type="number" name="attr_res-val" title="@{res-val}" value="1">
                </div>

              </fieldset>

            </div>
          </div>

        </div>

        <div class="pc-gears">

          <!-- Equipements divers (free-form) -->
          <div class="misc-gears">
            <div class="block-title block-header">
              Equipement divers
            </div>
            <textarea name="attr_equip_divers" title="@{equip_divers}" value=""></textarea>
          </div>

          <!-- Notes -->
          <div class="notes">
            <div class="block-title block-header">
              Notes
            </div>
            <textarea name="attr_notes" title="@{notes}" value=""></textarea>
          </div>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Config -->
      <div class="pc-config-tab">
        <h3>Configuration</h3>

        <ul>
          <li>
            Jets&nbsp;:&nbsp;
            <select class="select-md" name="attr_togm" title="@{togm}">
              <option value="" selected>Publics</option>
              <option value="/w gm ">Chuchotés au MJ</option>
            </select>
          </li>
        </ul>
      </div>

      <!-- Fiche PJ, Onglet Version -->
      <div class="pc-version-tab">
        <h3>Version</h3>

      </div>


    </div>

    <!-- Fiche PNJ -->
    <div class="cof-npc">
      <input type="hidden" class="tabs-toggle" name="attr_npc_tab" value="main" />
      <div>
        <button type="action" name="act_npc_main-btn" class="main-tab tab-btn npc-main-btn">CARACS</button>
        <button type="action" name="act_npc_config-btn" class="main-tab tab-btn npc-config-btn">CONFIGURATION</button>
      </div>

      <div class="npc-main-tab">

        <div class="npc-2colrow">
  
          <div>
            <h4>Attributs</h4>
  
            <div class="npc-3colrow">
              <div class="bordered">
                FOR
              </div>
              <div class="bordered">
                DEX
              </div>
              <div class="bordered">
                CON
              </div>
            </div>
  
            <div class="npc-3colrow">
              <div class="bordered">
                INT
              </div>
              <div class="bordered">
                PER
              </div>
              <div class="bordered">
                CHA
              </div>
            </div>
  
            <div class="npc-3colrow">
              <div class="bordered">
                Init.
              </div>
              <div class="bordered">
                DEF
              </div>
              <div class="bordered">
                DEP
              </div>
            </div>
  
            <div class="npc-2colrow">
              <div class="bordered">
                PV
              </div>
            </div>
  
          </div>
          
          <div>
            <h4>Bio</h4>
            <textarea name="attr_pnj_bio" title="@{pnj_bio}" rows="4" value=""></textarea>
  
            <h4>Divers</h4>
            <textarea name="attr_pnj_divers" title="@{pnj_divers}" rows="4" value=""></textarea>
          </div>
  
        </div>

        <hr>
        <h4>Attaques</h4>

        <hr>
        <h4>Capacités</h4>

      </div>

      <div class="npc-config-tab">
        CONFIG

        <hr>

        <details>
          <summary>Importer un statblock</summary>
          
        </details>

      </div>

    </div>

  </div>
</div>

<rolltemplate class="sheet-rolltemplate-cof2">

  {{^token}}
  <div class="sheet-rt sheet-rt-header sheet-rt-title">
    {{perso}}
  </div>
  {{/token}}
  {{#token}}
  <div class="sheet-rt sheet-rt-2cols sheet-rt-header sheet-rt-title">
    <div>{{token}}</div>
    <div>{{perso}}</div>
  </div>
  {{/token}}
  <div class="sheet-rt sheet-rt-2cols sheet-rt-header">
    <div>{{lsub}}</div>
    <div>{{rsub}}</div>
  </div>
  {{#roll}}
  <div class="sheet-rt sheet-rt-roll">
    {{roll}} 
    {{#rollbm}}
    | {{rollbm}}
    {{/rollbm}}
  </div>
  {{/roll}}
  {{#dm}}
  <div class="sheet-rt sheet-rt-2cols">
    <div>DM</div>
    <div>{{dm}}</div>
  </div>
  {{/dm}}
  {{#text}}
  <div class="sheet-rt sheet-rt-text">
    <span style="{{text_style}}">{{text}}</span>
  </div>
  {{/text}}

</rolltemplate>

<script type="text/worker">

/**
 * COF2e Sheet Worker
 */

 const SWData = {
  settings: {
    debugMode: false,
    hiddenClass: "hidden",
    visibleClass: "visible"
  },
  SHEET_TYPE: {
    PC: "pc",
    NPC: "npc"
  },
  RT_OPTIONS: {
    template: "cof2"
  },
  PC: {
    ABILITIES: [ "agilité", "constitution", "force", "perception", "charisme", "intelligence", "volonté" ],
    COMBAT: {
      init: [ "per", "init_buff" ],
      attacks: [ 
        [ "atkcac", "for", "Au Contact" ],
        [ "atktir", "agi", "A Distance" ], 
        [ "atkmag", "vol", "Magique" ]
      ]
    },
    CONDITIONS: [ 
      { 
        code: "F", 
        button: "affaibli",
        label: "Affaibli",
        effects: {
          droll: "dmalus"
        }
      },
      { 
        code: "A", 
        button: "aveugle",
        label: "Aveuglé",
        effects: {
          init: -5,
          atkcac: -5,
          def: -5,
          atktir: -10
        } 
      }, 
      { 
        code: "O", 
        button: "essoufle",
        label: "Essouflé",
        effects: {
          movement: 5
        }
      }, 
      { 
        code: "E", 
        button: "etourdi",
        label: "Etourdi",
        effects: {
          def: -5
        }
      }, 
      { 
        code: "I", 
        button: "immobilise", 
        label: "Immobilisé",
        effects: {
          movement: 0,
          atkcac: "dmalus",
          atktir: "dmalus",
          atkmag: "dmalus",
        }
      }, 
      { 
        code: "V", 
        button: "invalide", 
        label: "Invalide",
        effects: {
          movement: 5
        }
      }, 
      { 
        code: "P", 
        button: "paralyse", 
        label: "Paralysé"
      }, 
      { 
        code: "L", 
        button: "ralenti",
        label: "Ralenti" 
      }, 
      { 
        code: "R", 
        button: "renverse",
        label: "Renversé",
        effects: {
          atkcac: -5,
          atktir: -5,
          atkmag: -5,
          def: -5
        }
      }, 
      { 
        code: "S", 
        button: "surpris",
        label: "Surpris",
        effects: {
          def: -5
        }
      }
    ]
  }
}

// =================
// UTILITY FUNCTIONS
// =================

/**
* Convert to integer
* @param {string} value - value to cast
* @param {int} onError - default value on error
* @returns integer value
*/
function int(value, onError = 0) {
  return parseInt(value) || onError;
}

/**
* Convert to float
* @param {string} value - value to cast
* @param {float} onError - default value on error
* @returns float value
*/
function float(value, onError = 0) {
  return parseFloat(value) || onError;
}


/**
* Get string or empty value
* @param {string} value - value to cast
* @param {string} onError - default value on null/undefined
* @returns string value
*/
function stringOrDefault(value, onError = "") {
  return value || onError;
}

/**
* Capitalize string
* @param {string} str - string to capitalize
* @returns capitalized string
*/
function capitalize(str) {
  if (str && str !== "")
    return str.charAt(0).toUpperCase() + str.substring(1);
}

/**
 * Return ability short name
 * @param {string} ability - ability name
 * @returns {string}
 */
function shorten(ability) {
  return ability.substring(0, 3);
}

/**
* Log to JS console with color & style
* @param {any} data - data to log
* @param {string} title - title of logged data
* @param {string} color - color name for log line
* @param {string} style - CSS style for log line
* @param {string} headerStyle - CSS style for log title
*/
function clog(
  data,
  title = "",
  color = { text: "green", back: "" },
  style = "font-size:12px; font-weight:normal;",
  headerStyle = "font-size:13px; font-weight:bold;"
) {
  if (!SWData.settings.debugMode)
    return;

  title = stringOrDefault(title, "");
  if (title !== "") title = ` Sheet-Worker : ${title} `;
  const titleStyle = `color:${color.text}; background-color:${color.back}; ${headerStyle} text-decoration:underline;`;
  const textStyle = `color:${color.text}; background-color:${color.back}; ${style}`;

  if (title) {
    if (typeof data === "object") {
      const output = `%c${title}`;
      console.log(output, titleStyle, data);
    } else {
      const output = `%c${title} %c${data}`;
      console.log(output, titleStyle, textStyle);
    }
  } else {
    if (typeof data === "object") {
      console.log(data);
    } else {
      const output = `%c${data}`;
      console.log(output, textStyle);
    }
  }
}

/**
* Generate a random number between 1 and max
* @param {integer} max - Upper bound of range
* @returns {integer} Generated random number
*/
function getRandom(max) {
  const min = 1;
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

/**
* Parse a chunk of data into name & value
* @param {string} data - Chunk of data to parse
* @param {string} delim - Delimiter (defaults to ':')
* @returns an object with name and value properties
*/
function parseNameValue(data, delim) {
  delim = stringOrDefault(delim, ":");
  if (data.indexOf(delim) !== -1) {
    let [ key, value ] = data.split(delim);
    key = stringOrDefault(key).trim();
    value = stringOrDefault(value).trim()
  }
  return { name: key, value };
}

/**
 * Return a sequence of numbers as an array
 * @param {number} count - Length of the sequence
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {number[]}
 */
function seq(count, base = 1) {
  return [ ...Array(count).keys() ].map(i => i += base);
}

/**
 * Return a sequence of names
 * @param {number} count - Length of the sequence
 * @param {string} name - Name template (with | placeholder to insert the sequence)
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {string[]}
 */
 function nameSeq(count, name, base = 1) {
  const [ prepend, append ] = name.split("|");
  return seq(count, base).map(s => `${prepend || ""}${s}${append || ""}`)
}

/**
 * Return a list of event as array or as string
 * @param {string} eventName - Name of the event
 * @param {string[]} attributeList - List of attributes
 * @param {string} joinChar - Character to use for joining the items
 * @returns {string[]|string}
 */
function eventList(eventName, attributeList, joinChar = "") {
  const result = attributeList.map(a => `${eventName}:${ a.toLowerCase() }`)
  return joinChar !== "" ? result.join(joinChar) : result;
}

/**
* Remove all rows for a repeating section
* @param {string} sectionName Repeating section to clear
*/
function removeRepeatingAll(sectionName) {
  getSectionIDs(sectionName, function (rowIds) {
    rowIds.forEach(rowId => {
      removeRepeatingRow(`repeating_${sectionName}_${rowId}`);
    });
  });
}

/** @typedef sendChatMsgOptions
 * @property {string} title - Title of the message
 * @property {string} template - Name of roll template
 * @property {string} whisper - Target for whispered message
 */

/**
 * Send a message to chat
 * @param {string|string[]} msg - Message to send
 * @param {sendChatMsgOptions} options - Options for the message
 */
function buildChatMsg(msg, options = {}) {
  let { title = "", template = "default", whisper = "@{togm}" } = options;
  if (whisper.charAt(0) !== "@" && whisper !== "") whisper = "/w \"" + whisper + "\" ";
  let chatMsg;
  if (Array.isArray(msg)) {
    chatMsg = msg.map(t => `{{${t} }}`).join(" ");
  } else {
    chatMsg = "{{" + msg + "}}";
  }
  return `${whisper}&{template:${template}} ${title ? (template === "default" ? `{{name=${title} }}` : `{{${title} }}`) : "" } ${chatMsg}`;
}

/**
 * Send a message to chat
 * @param {string|string[]} msg - Message to send
 * @param {sendChatMsgOptions} options - Options for the message
 */
 function sendChatMsg(msg, options = {}) {
  const chatCmd = buildChatMsg(msg, options);
  startRoll(chatCmd, roll => {
      finishRoll(roll.rollId);
  });
}

/**
 * Return COF 2e rolltemplate
 * @param {object} props - List of {{ }} sections as object properties
 * @returns {string[]}
 */
function cof2RollTemplate(props) {
  return [
    "perso=@{character_name}",
    ...Object.entries(props).map(e => {
      const [ prop, value ] = e;
      return `${prop}=${value} `;
    })
  ];
}

/**
 * Send a single value roll query to chat and process response
 * @param {string} prompt - Input box label
 * @param {object} callback - Callback function to process input
 */
function askValue(prompt, callback) {
  const askValue = `!{{ask=[[?{${prompt}}]]}}`;
  startRoll(askValue, question => {
    const query = question.results.ask.result;
      if(query && callback) {
          callback(query);
      }
  });
}

/**
 * Send a drop-down roll query to chat and process response
 * @param {string|array} askParams - Parameters of the roll query 
 * @param {object} callback - Callback function to process input
 */
function ask(askParams, callback) {
  if (!Array.isArray(askParams)) {
    askParams = [ askParams, "Non", "Oui" ];
  }
  const [ prompt, ...choices ] = askParams;
  const choice = choices.map((ch, ix) => `${ch},${ix}`).join("|");
  const ask = `!{{ask=[[?{${prompt}|${choice}}]]}}`;
  startRoll(ask, question => {
      const query = question.results.ask.result;
      if(query && callback) {
          callback(query, choices);
      }
      //finishRoll(question.rollId);
  });
};

/**
 * Add numeric attributes values
 * @param {object} values - getAttrs object with numeric values
 * @returns - {number}
 */
function addValues(values) {
  return Object.keys(values).reduce((result, attr) => {
    return result + int(values[attr]);
  }, 0);
}

/**
 * Return the die roll formula for type
 * @param {string} type - Type of d20 roll
 * @returns - {string}
 */
function dieRoll(type) {
  if (type === "S") return "2d20kh1";
  if (type === "H") return "{2d20kh1, 0d20+10}kh1";
  return "1d20";
}

/**
 * Show a div area via Roll20 jQuery
 * @param {string} div - Name of div area to show
 */
function showArea(div) {
  $20(`.${div}`).removeClass(SWData.settings.hiddenClass);
  $20(`.${div}`).addClass(SWData.settings.visibleClass);
}

/**
 * Hide a div area via Roll20 jQuery
 * @param {string} div - Name of div area to hide
 */
function hideArea(div) {
  $20(`.${div}`).removeClass(SWData.settings.visibleClass);
  $20(`.${div}`).addClass(SWData.settings.hiddenClass);
}

// ============
// SHEET EVENTS
// ============

/**
 * Change identity heading
 */
on("change:sheet_type", function() {
  getAttrs([ "sheet_type" ], function(value) {
    const sheet_type = stringOrDefault(value.sheet_type);
    if (!sheet_type) return;

    Object.values(SWData.SHEET_TYPE).forEach(type => {
      if (type === sheet_type) {
        showArea(`identity-${type}`);
      } else {
        hideArea(`identity-${type}`);
      }
    })

  });
});

/**
 * Change tabs
 */
[ 
  "pc_main", "pc_abilities", "pc_gears", "pc_config", "pc_version",
  "npc_main", "npc_config"
].forEach(button => {
  on(`clicked:${button}-btn`, function() {
    const [ type, value ] = button.split("_");
    setAttrs({
        [`${type}_tab`]: value
    });
  });
});

/**
 * Change subtabs
 */
[ "rolls", "buffs" ].forEach(button => {
  on(`clicked:pc_${button}-btn`, function() {
      setAttrs({
          pc_subtab: button
      });
  });
});

/**
 * Update the base attack scores
 */
function updateAttacksBase() {
  getAttrs([ "niveau" ], function(value) {
    const level = int(value.niveau);
    const atkBase = Math.min(level, 10);
    setAttrs({
      atkcac_base: atkBase,
      atktir_base: atkBase,
      atkmag_base: atkBase,
    });
  })
}

/**
 * On level change
 */
on("change:niveau", updateAttacksBase);

/**
 * On ability components change
 */
SWData.PC.ABILITIES.forEach(ability => {
  const short = shorten(ability);
  const attrs = [ 
    short, 
    `${short}_buff` 
  ];
  on(eventList("change", attrs, " "), function () {
    getAttrs(attrs, function(values) {
      const score = addValues(values);
      setAttrs({ [`${short}_test`]: score });
    });
  });
});

/**
 * Update the init attribute
 */
function updateInit() {
  getAttrs(SWData.PC.COMBAT.init, function(values) {
    const init = 10 + addValues(values);
    setAttrs({ init });
  });
}

/**
 * On init components change
 */
on(eventList("change", SWData.PC.COMBAT.init, " "), updateInit);

/**
 * On attacks components change
 */
SWData.PC.COMBAT.attacks.forEach(attk => {
  const [ attack, ability ] = attk;
  const changed = [ `${attack}_base`, `${ability}` , `${attack}_buff` ];
  on(eventList("change", changed, " "), function() {
    getAttrs(changed, function(values) {
      const score = addValues(values);
      setAttrs({ [`${attack}`]: score });
    });
  });
});

/**
 * Compute max DR
 */
function updateDRMax() {
  getAttrs([ "con" ], function(value) {
    const dr_max = 2 + int(value.con);
    setAttrs({ dr_max });
  });
}

/**
 * On CON change
 */
on("change:con", updateDRMax);

/**
 * On ability button click
 */
SWData.PC.ABILITIES.forEach(ability => {
  const short = shorten(ability);
  on(`clicked:${short}-btn`, function () {
    getAttrs([ `d${short}_sup` ], function(values) {
      const [ dType ] = Object.keys(values);
      const roll = dieRoll(values[dType]);
      const armor_malus = short === "agi" ? " - @{armor_malus}[Armure]" : "";
      const carac = `[[${roll}[Dé] + @{${short}_test}[Bonus ${short.toUpperCase()}]${armor_malus} ]] `;
      const chatMsg = cof2RollTemplate({
        lsub: "Test",
        rsub: capitalize(ability),
        roll: carac
      });
      sendChatMsg(chatMsg, SWData.RT_OPTIONS);
      console.log(chatMsg);
    });
  });
});

/**
 * On attack button click
 */
SWData.PC.COMBAT.attacks.forEach(attk => {
  const [ attack, , description ] = attk;
  on(`clicked:${attack}-btn`, function () {
    const attaque = `[[1d20cs20cf1[Dé] + @{${attack}}[Bonus] ]]`;
    const chatMsg = cof2RollTemplate({
      lsub: "Attaque",
      rsub: description,
      roll: attaque
    });
    sendChatMsg(chatMsg, SWData.RT_OPTIONS);
  });
});

on("clicked:drecup-btn", function() {
  getAttrs([ "dr", "drecup", "niveau" ], function(values) {
    let dr = int(values.dr);
    if (dr === 0) {
      const chatMsg = cof2RollTemplate({
        lsub: "Jet",
        rsub: "Récupération Rapide",
        text: "Plus de DR !",
        text_style: "color: red;"
      });
      sendChatMsg(chatMsg, SWData.RT_OPTIONS);
      return;
    }

    dr -= 1;
    const dRecup = `d${values.drecup}`;
    const bRecup = Math.ceil(int(values.niveau) / 2);
    const recup = `[[${dRecup}[DR] + ${bRecup}[Niveau/2] ]] PV récupérés`;
    const chatMsg = cof2RollTemplate({
      lsub: "Jet",
      rsub: "Récupération Rapide",
      roll: recup,
      text: `${dr} DR restants`
    });
    sendChatMsg(chatMsg, SWData.RT_OPTIONS);

    setAttrs({ dr });
  });
});

/**
 * Show weapons options
 */
on("clicked:repeating_armes:arme-opt-btn", function() {
  getAttrs([ "repeating_armes_arme-opt" ], function(value) {
    let [ option ] = Object.values(value);
    option = 1 - int(option);
    setAttrs( { ["repeating_armes_arme-opt"]: option });
  });
});


</script>